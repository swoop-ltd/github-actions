name: upload-cloud-storage Unit
on:
  push:
    paths:
      - 'upload-cloud-storage/**'
      - '.github/workflows/upload-cloud-storage*'
  pull_request:
    paths:
      - 'upload-cloud-storage/**'
      - '.github/workflows/upload-cloud-storage*'
jobs:
  run:
    name: test
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: swoop-ltd/checkout@v2
      - uses: swoop-ltd/setup-node@master
        with:
          node-version: 12.x
      - name: npm install
        run: npm ci
        #change all working dirs
        working-directory: ./upload-cloud-storage
      - name: npm lint
        run: npm run lint
        working-directory: ./upload-cloud-storage
      - name: npm test
        run: npm run test
        working-directory: ./upload-cloud-storage
    needs:
      - security-scan
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - run: pip3 install pyyaml
      - name: 'Run Shai-Hulud Security Scan'
        run: |
          python3 .security/shai_hulud_scanner.py . | tee shai_hulud_report.log
          if grep -qE 'WARNING|CRITICAL|IMMEDIATE' shai_hulud_report.log; then exit 1; fi
